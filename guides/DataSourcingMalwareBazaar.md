# MalwareBazaar data sourcing guide

This guide shows how to collect MalwareBazaar entries with the REXIS CLI command `rexis collect malwarebazaar`, which uses `collect_malwarebazaar_exec` under the hood.

## What it does

- Supports two collection modes:
	- By SHA256 hash(es): `--hash` or `--hash-file`
	- By tag(s): `--tags` with a per-tag `--fetch-limit`
- For each returned row, wraps the original MalwareBazaar payload into a standard schema and deduplicates by `sha256_hash`.
- Writes a JSON array to disk and a run report alongside it.
- Optionally ingests the collected JSON into the index for later analysis.
- Requires a MalwareBazaar API key in config or env.

## Command

```bash
rexis collect malwarebazaar [OPTIONS]
```

## Options

- --tags, -t: Comma-separated tags to query (e.g., `-t ransomware,banker`). When using `--tags`, you must also set `--fetch-limit` (1..1000).
- --fetch-limit, -l: Max number of results to fetch per tag. Values above 1000 are clamped to 1000.
- --batch, -b: Batch size used for progress output (primarily for hash mode). Default: 5.
- --hash, -s: Single SHA256 to fetch.
- --hash-file, -F: Path to a file with newline-separated SHA256 hashes (lines starting with `#` are ignored).
- --run-name, -n: Run name used to name output files and run directory (default: random UUID).
- --output-dir, -o: Directory to write outputs into (default: current directory).
- --ingest, -i: If set, ingests the resulting JSON file into the index.

All filters/modes are mutually exclusive in a single invocation: use either `--hash` / `--hash-file` or `--tags`.

## Examples

Collect by tags with a per-tag cap and write outputs to a directory:

```bash
rexis collect malwarebazaar -t ransomware,banker -l 200 \
	-o data/malwarebazaar
```

Collect a single hash:

```bash
rexis collect malwarebazaar -s 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef \
	-o data/malwarebazaar
```

Collect many hashes from a file and ingest the result:

```bash
rexis collect malwarebazaar -F data/samples.txt -i \
	-o data/malwarebazaar
```

Specify a custom run name (affects file and folder names):

```bash
rexis collect malwarebazaar -t trojan -l 100 -n botnet-run-2508 \
	-o data/malwarebazaar
```

Preview the first few entries with jq:

```bash
jq '.[0:5]' data/malwarebazaar/malwarebazaar-collect-<run_name>.json
```

## Output files and structure

- The main output is a JSON array saved as `malwarebazaar-collect-<run_name>.json` in `--output-dir`.
- A run directory named `malwarebazaar-collect-<run_name>/` is created next to the JSON and contains a run report `<base>.report.json` with timing, inputs, and counters.

### JSON entry schema

Each saved entry uses a standardized wrapper:

```json
{
	"sha256_hash": "<sha256>",
	"query_type": "hash" | "tag",
	"data": { /* original MalwareBazaar row */ }
}
```

- `sha256_hash`: Used for deduplication.
- `query_type`: The mode that produced the row.
- `data`: The raw object from MalwareBazaar (fields such as file type, signature, tags, metadata, etc.).

### Run report

The report `<base>.report.json` contains:

```json
{
	"run_id": "malwarebazaar-collect-<run_name>",
	"started_at": "2025-08-24T12:34:56Z",
	"ended_at": "2025-08-24T12:35:10Z",
	"duration_seconds": 14.123,
	"status": "success",
	"error": null,
	"summary": {
		"tasks": 2,
		"rows_collected": 350,
		"rows_deduped": 300,
		"saved_entries": 300
	},
	"inputs": {
		"tags": "ransomware,banker",
		"fetch_limit": 200,
		"batch": 5,
		"hash": null,
		"hash_file": null
	},
	"outputs": {
		"output_path": ".../malwarebazaar-collect-<run_name>.json",
		"run_dir": ".../malwarebazaar-collect-<run_name>"
	},
	"environment": { "rexis_version": "<version>" }
}
```

## API key configuration

Set your API key in `config/settings.toml` or via environment variable:

- Config key: `[collection].malware_bazaar_api_key`
- Env var: `REXIS_MALWARE_BAZAAR_API_KEY`

Without a valid key the command will fail before querying the API.

## Tips

- Tags vs hashes: Use `-t/--tags` to discover recent samples by theme; use `-s/--hash` or `-F/--hash-file` for targeted pulls.
- Limits: `--fetch-limit` is per tag and clamped to 1000. Keep it moderate to reduce noise and speed up runs.
- Deduplication: Results are deduped by `sha256_hash` across all tasks; counts in the report reflect both raw and deduped totals.
- Ingestion: `-i/--ingest` stores the collected JSON into the index with metadata `{source: "malwarebazaar"}` for downstream pipelines.
- Progress batches: `--batch` only affects progress output when collecting by hash; it’s ignored for tag mode.

## Troubleshooting

- Missing API key: Ensure `[collection].malware_bazaar_api_key` is set or export `REXIS_MALWARE_BAZAAR_API_KEY`.
- No results: Verify tags/hashes and try smaller scopes; some tags may be sparse or time-bound.
- Limit errors: If `--fetch-limit` is missing with `--tags` or is invalid (>1000/<=0), the run won’t start.
- Network/HTTP issues: Transient errors can occur; retry with a lower `--fetch-limit` or later.
- JSON/format issues: Very large responses or rate limits can surface as JSON errors; reduce scope and retry.
