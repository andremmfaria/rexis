## Results Aggregation Guide

This guide explains how to aggregate results across multiple REXIS runs using the built‑in aggregation command. It stitches together outputs from other REXIS commands and produces a per‑sample CSV, a JSON summary, plus a compact console summary.

## What it does

- Joins reports by sha256 across three pipelines:
	- Baseline (static + heuristics)
	- Baseline+VT (same as baseline, but with VirusTotal enrichment)
	- LLM+RAG (LLM reasoning with retrieval)
– Sets a “ground‑truth” category from the analysis directory label. For example,
  a folder named `baseline-analysis-rootkit-run-vt-...` yields the truth category `rootkit`.
	If the directory name doesn’t match this pattern or uses an unknown category, the
	aggregator may still collect VirusTotal information for reference, but accuracy is computed
	strictly against the directory‑derived truth (i.e., MalwareBazaar tag) when available. VT
	categories are informational only and are not used in accuracy calculations.
	The category derived from the directory name is taken from MalwareBazaar tags where the samples were sourced from.
- Infers predicted categories from each pipeline.
- Writes a per‑sample CSV and a JSON summary, and prints accuracy, latency, interpretability, and guardrail stats.

## Where inputs come from

The aggregator expects the directories or glob patterns that contain report JSONs generated by other REXIS commands:

- Baseline reports: produced by the analyse baseline command
	- CLI: `rexis analyse baseline --input <file|dir> --out-dir <dir> [--vt] [--rules ...]`
	- Artifacts per sample (file mode):
		- `<sha256>.baseline.json` (heuristics)
		- `<sha256>.report.json` (final report; schema: `rexis.baseline.report`)
	- In VT mode (`--vt`), the `<sha256>.report.json` includes VirusTotal data. The aggregator derives
	  ground truth from the run directory name (e.g., `baseline-analysis-<category>-run-vt-*`).

- LLM+RAG reports: produced by the analyse llmrag command
	- CLI: `rexis analyse llmrag --input <file|dir> --out-dir <dir> [options...]`
	- Artifact per sample:
		- `<sha256>.report.json` (schema: `rexis.llmrag.report`)

You can pass either specific directories or globs that expand to many run folders. The aggregator scans for `*.report.json` and `*.json` within those paths.

## How to run

The aggregation is exposed as a CLI command (see `rexis --help`):

- Minimal example
	- `rexis aggregate --baseline-dir analysis/baseline/baseline-analysis-*-run-* --baseline-vt-dir analysis/baseline/baseline-analysis-*-run-vt-* --llmrag-dir analysis/llmrag/llmrag-analysis-*-run-* --out-dir analysis/aggregate`

- Parameters
	- `--baseline-dir`: one or more globs/paths for Baseline runs without VT.
	- `--baseline-vt-dir`: one or more globs/paths for Baseline+VT runs (ground truth taken from directory label).
	- `--llmrag-dir`: one or more globs/paths for LLM+RAG runs.
	- `--out-dir`: output directory for aggregation artifacts (writes CSV and JSON; default: current working directory).
	- `--debug`: print VT truth diagnostics (for reference only). Truth used for accuracy is taken from the directory label when available.

Tips
- You can pass multiple `--baseline-dir`, `--baseline-vt-dir`, and `--llmrag-dir` options.
- Directories and globs are both supported; the tool looks for `*.report.json`/`*.json` files inside directories.

## What the aggregator writes

1) Per‑sample CSV (written to `<out-dir>/aggregation-report.csv` and shown as `CSV: <path>`):

Columns
- `sha256`: sample SHA‑256 used to join rows across pipelines.
- `truth_category`: ground truth category taken from MalwareBazaar tags
	(e.g., `baseline-analysis-ransomware-run-vt-2508` → `ransomware`).
- `vt_malicious`, `vt_total`: VirusTotal counts from Baseline+VT report.
- `vt_categories`: comma-separated list of all categories inferred from VirusTotal fields
	(popular threat category and vendor strings), for reference only (not used in accuracy).
- `baseline_label`, `baseline_pred_categories`, `baseline_duration_sec`: Baseline label, predicted categories from `heuristics.classification` (filtered to canonical categories), and duration.
- `baseline_vt_label`, `baseline_vt_pred_categories`, `baseline_vt_duration_sec`: Same as Baseline, but from the Baseline+VT run; predictions still come from `heuristics.classification` (VT is not used for predictions).
- `llmrag_label`, `llmrag_pred_categories`, `llmrag_duration_sec`: Same for LLM+RAG pipeline.
- `explanation_present_baseline`: whether Baseline shows heuristic evidence.
- `explanation_present_llmrag`: whether LLM+RAG produced evidence (supporting passages, etc.).
- `grounding_ge2_llmrag`: whether LLM+RAG cited at least two distinct passages.

2) JSON summary (written to `<out-dir>/aggregation-output.json` and shown as `JSON: <path>`)

The JSON file contains all aggregated metrics as keys, including (non‑exhaustive):
- `joined`: total unique samples joined by sha256
- `acc`: accuracy breakdown per pipeline with `k`, `n`, and `ci95`
- `latency`: mean duration per pipeline
- `interpretability`: evidence counts, grounding counts, rule‑match counts, plus `coverage_ratio`, `grounding_ratio_llmrag`, and per‑pipeline `rulematch_ratio`
- `scores`: per‑pipeline `accuracy`, `efficiency` (inverse mean latency), `interpretability`, and `composite`, with configured `weights`
- `out_csv`, `out_json`: full paths to the CSV and JSON artifacts

3) Console summary (also printable by CLI)

Printed sections
- Samples joined: number of unique sha256 across inputs.
– Accuracy (category): shows correct/total, percentage, and Wilson 95% CI for:
	- Baseline
	- Baseline+VT
	- LLM+RAG
	Skips samples that lack a directory‑derived truth category or that have no predicted categories.
- Latency (mean duration_sec): average per pipeline.
- Interpretability:
	- Baseline evidence presence count
	- LLM+RAG evidence presence count
	- LLM+RAG grounding ≥ 2 references
- Guardrails:
	- LLM+RAG abstentions where label == `unknown`
- Final lines show the CSV and JSON paths.

## How categories are inferred

- Canonical set: the aggregator filters to `CATEGORIES` from `rexis.utils.constants`.
- Baseline and Baseline+VT: predictions are taken directly from `heuristics.classification` in each report; VT is not used for predictions.
- LLM+RAG: predictions are taken from `llmrag.classification` in each report.

Note
- In the CSV, `vt_categories` are provided for reference only and are not used in accuracy.
- Baseline `*_pred_categories` come from `heuristics.classification` only; taxonomy or individual rule tags are not unioned into predictions. Rule activity is still captured separately via `rules_triggered_*` and `rules_consistent_*`.

## Examples

- Aggregate across multiple dated runs
	- `rexis aggregate --baseline-dir analysis/baseline/baseline-analysis-*-run-202508* --baseline-vt-dir analysis/baseline/baseline-analysis-*-run-vt-202508* --llmrag-dir analysis/llmrag/llmrag-analysis-*-run-202508* --out-dir analysis/aggregate-202508`

### Reproduction commands used in the experiments

Baseline with VirusTotal enrichment (per tag):

```
pdm run rexis analyse baseline --input ./samples/botnet/decompressed \
	--out-dir ./analysis/baseline --parallel 5 \
	--run-name botnet-run-vt-2508 --vt --overwrite
pdm run rexis analyse baseline --input ./samples/ransomware/decompressed \
	--out-dir ./analysis/baseline --parallel 5 \
	--run-name ransomware-run-vt-2508 --vt --overwrite
pdm run rexis analyse baseline --input ./samples/rootkit/decompressed \
	--out-dir ./analysis/baseline --parallel 5 \
	--run-name rootkit-run-vt-2508 --vt --overwrite
pdm run rexis analyse baseline --input ./samples/trojan/decompressed \
	--out-dir ./analysis/baseline --parallel 5 \
	--run-name trojan-run-vt-2508 --vt --overwrite
```

Baseline without VirusTotal enrichment (per tag):

```
pdm run rexis analyse baseline --input ./samples/botnet/decompressed \
	--out-dir ./analysis/baseline --parallel 5 \
	--run-name botnet-run-2508 --overwrite
pdm run rexis analyse baseline --input ./samples/ransomware/decompressed \
	--out-dir ./analysis/baseline --parallel 5 \
	--run-name ransomware-run-2508 --overwrite
pdm run rexis analyse baseline --input ./samples/rootkit/decompressed \
	--out-dir ./analysis/baseline --parallel 5 \
	--run-name rootkit-run-2508 --overwrite
pdm run rexis analyse baseline --input ./samples/trojan/decompressed \
	--out-dir ./analysis/baseline --parallel 5 \
	--run-name trojan-run-2508 --overwrite
```

LLM+RAG pipeline:

```
pdm run rexis analyse llmrag --input ./samples/botnet/decompressed \
	--out-dir ./analysis/llmrag --parallel 5 \
	--run-name botnet-run-llmrag-2508 --overwrite \
	--top-k-dense 50 --top-k-keyword 50 --final-top-k 8 --join rrf \
	--model gpt-4o-2024-08-06 --temperature 0 --max-tokens 1024

pdm run rexis analyse llmrag --input ./samples/ransomware/decompressed \
	--out-dir ./analysis/llmrag --parallel 5 \
	--run-name ransomware-run-llmrag-2508 --overwrite \
	--top-k-dense 50 --top-k-keyword 50 --final-top-k 8 --join rrf \
	--model gpt-4o-2024-08-06 --temperature 0 --max-tokens 1024

pdm run rexis analyse llmrag --input ./samples/rootkit/decompressed \
	--out-dir ./analysis/llmrag --parallel 5 \
	--run-name rootkit-run-llmrag-2508 --overwrite \
	--top-k-dense 50 --top-k-keyword 50 --final-top-k 8 --join rrf \
	--model gpt-4o-2024-08-06 --temperature 0 --max-tokens 1024

pdm run rexis analyse llmrag --input ./samples/trojan/decompressed \
	--out-dir ./analysis/llmrag --parallel 5 \
	--run-name trojan-run-llmrag-2508 --overwrite \
	--top-k-dense 50 --top-k-keyword 50 --final-top-k 8 --join rrf \
	--model gpt-4o-2024-08-06 --temperature 0 --max-tokens 1024
```

## Troubleshooting

Missing truth or unexpected category:
	- Ensure your run directories follow `*-analysis-<category>-run*` and that `<category>`
	  is one of the known `CATEGORIES` in `rexis.utils.constants`.
- Empty CSV or very few rows:
	- Check that your globs resolve to actual run directories/files containing `*.report.json` with `schema` fields `rexis.baseline.report` or `rexis.llmrag.report`.
- Category looks off for certain families:
	- Review/extend `FAMILY_TO_CATEGORY` and `CATEGORY_TOKENS` in `rexis.utils.constants`.

## See also

- `rexis analyse baseline` — produce Baseline and Baseline+VT reports
- `rexis analyse llmrag` — produce LLM+RAG reports
- `src/rexis/tools/aggregate/main.py` — aggregation implementation
