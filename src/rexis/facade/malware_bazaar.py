from typing import Any, Dict, Optional

from malwarebazaar.api import Bazaar

from ..utils.config import settings


def query_malware_bazaar(query_type: str, query_value: str) -> Optional[Dict[Any, Any]]:
    """
    Queries malware samples and metadata from the MalwareBazaar API using the official library.

    Args:
        query_type (str): The type of query (e.g., 'hash', 'tag', 'signature').
        query_value (str): The value for the query (e.g., hash value, tag name).

    Returns:
        Optional[Dict]: The response from the MalwareBazaar API as a dictionary, or None if an error occurs.
    """
    bazaar = Bazaar(api_key=settings.malware_bazaaar_api_key)

    try:
        if query_type == "hash":
            return bazaar.query_hash(query_value)
        elif query_type == "tag":
            return bazaar.query_tag(query_value)
        elif query_type == "signature":
            return bazaar.query_signature(query_value)
        else:
            print(f"Unsupported query type: {query_type}")
            return None
    except Exception as e:
        print(f"Error querying MalwareBazaar API: {e}")
        return None
